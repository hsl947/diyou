





<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
  <link rel="dns-prefetch" href="https://assets-cdn.github.com">
  <link rel="dns-prefetch" href="https://avatars0.githubusercontent.com">
  <link rel="dns-prefetch" href="https://avatars1.githubusercontent.com">
  <link rel="dns-prefetch" href="https://avatars2.githubusercontent.com">
  <link rel="dns-prefetch" href="https://avatars3.githubusercontent.com">
  <link rel="dns-prefetch" href="https://github-cloud.s3.amazonaws.com">
  <link rel="dns-prefetch" href="https://user-images.githubusercontent.com/">



  <link crossorigin="anonymous" media="all" integrity="sha512-eYhUAIv4O/68uoHkCtYXVTxc5Q92+NKMtOryYR5Svt7vDp34XkrggN5j4lrKyiB0B2HUyrAYvAb3tlhmFGhivg==" rel="stylesheet" href="https://assets-cdn.github.com/assets/frameworks-592c4aa40e940d1b0607a3cf272916ff.css" />
  <link crossorigin="anonymous" media="all" integrity="sha512-tAb2Jg5owcau6P+YFTlebsFvybAeFaii7FoIIuYEtgu+esY8+SX6Xhyw3fXb+f9QB6wwivUzgoXXwO8ZteApKA==" rel="stylesheet" href="https://assets-cdn.github.com/assets/github-fdbbae74da4136fd4258a92eb943be60.css" />
  
  
  <link crossorigin="anonymous" media="all" integrity="sha512-d/Z8qkPIypOBvoV6s1ReDDzT0gEGP9MX7VaLPp0MbdP6ev5P0JREdfzCsgvkd70vyrJZW9L5rO+xU/3qDHjD7A==" rel="stylesheet" href="https://assets-cdn.github.com/assets/site-348211d27070b0d7bb5d31b1ac3d265b.css" />
  

  <meta name="viewport" content="width=device-width">
  
  <title>vue-come-true/README.md at master · coderzzp/vue-come-true · GitHub</title>
    <meta name="description" content="GitHub is where people build software. More than 27 million people use GitHub to discover, fork, and contribute to over 80 million projects.">
  <link rel="search" type="application/opensearchdescription+xml" href="/opensearch.xml" title="GitHub">
  <link rel="fluid-icon" href="https://github.com/fluidicon.png" title="GitHub">
  <meta property="fb:app_id" content="1401488693436528">


  <meta name="html-safe-nonce" content="7552205bf5c0b54de6171bd694ea0a823eea94b2">

  <meta http-equiv="x-pjax-version" content="b59df07b8cd55bc615e6c910b91c860c">
  
  <meta name="description" content="vue-come-true - vue实现原理浅析">
  <meta name="go-import" content="github.com/coderzzp/vue-come-true git https://github.com/coderzzp/vue-come-true.git">

  <meta name="octolytics-dimension-user_id" content="24691802" /><meta name="octolytics-dimension-user_login" content="coderzzp" /><meta name="octolytics-dimension-repository_id" content="93227606" /><meta name="octolytics-dimension-repository_nwo" content="coderzzp/vue-come-true" /><meta name="octolytics-dimension-repository_public" content="true" /><meta name="octolytics-dimension-repository_is_fork" content="false" /><meta name="octolytics-dimension-repository_network_root_id" content="93227606" /><meta name="octolytics-dimension-repository_network_root_nwo" content="coderzzp/vue-come-true" /><meta name="octolytics-dimension-repository_explore_github_marketplace_ci_cta_shown" content="false" />

  <meta name="browser-stats-url" content="https://api.github.com/_private/browser/stats">

  <meta name="browser-errors-url" content="https://api.github.com/_private/browser/errors">

  <link rel="mask-icon" href="https://assets-cdn.github.com/pinned-octocat.svg" color="#000000">
  <link rel="icon" type="image/x-icon" class="js-site-favicon" href="https://assets-cdn.github.com/favicon.ico">

<meta name="theme-color" content="#1e2327">


  <meta name="u2f-support" content="true">

<link rel="manifest" href="/manifest.json" crossOrigin="use-credentials">

  </head>

  <body class="logged-out env-production page-blob">
    
  <div id="readme" class="readme blob instapaper_body">
    <article class="markdown-body entry-content" itemprop="text"><h3><a id="user-content-前言" class="anchor" aria-hidden="true" href="#前言"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>前言</h3>
<p>vue是一个非常典型的MVVM框架，它的核心功能一是双向数据绑定系统，二是组件化开发系统。那么本文是以一种通俗易懂的的角度来实现一个简单
的双向数据绑定系统，如果你用过vue却对vue的实现原理不太清楚，或者没用过vue想学习vue那我相信看完本文你会的vue的实现有一个比较简单明确的了解。不过如果哪块有
错误，还望指出。</p>
<h3><a id="user-content-本文的实现目标" class="anchor" aria-hidden="true" href="#本文的实现目标"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>本文的实现目标：</h3>
<p>input标签和{{text}}的内容与data中的text值保持一致，实现双向绑定</p>
<div class="highlight highlight-source-js"><pre>    <span class="pl-k">&lt;</span>div id<span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>app<span class="pl-pds">"</span></span><span class="pl-k">&gt;</span>
        <span class="pl-k">&lt;</span>input type<span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>text<span class="pl-pds">"</span></span> v<span class="pl-k">-</span>model<span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>text<span class="pl-pds">"</span></span><span class="pl-k">&gt;</span>
        {{text}}
    <span class="pl-k">&lt;</span><span class="pl-k">/</span>div<span class="pl-k">&gt;</span></pre></div>
<div class="highlight highlight-source-js"><pre>    <span class="pl-k">var</span> vm<span class="pl-k">=</span><span class="pl-k">new</span> <span class="pl-en">Vue</span>({
        el<span class="pl-k">:</span><span class="pl-s"><span class="pl-pds">'</span>app<span class="pl-pds">'</span></span>,
        data<span class="pl-k">:</span>{
            text<span class="pl-k">:</span><span class="pl-s"><span class="pl-pds">'</span>hello world!<span class="pl-pds">'</span></span>
        }
    })</pre></div>
<h3><a id="user-content-分解任务三步" class="anchor" aria-hidden="true" href="#分解任务三步"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分解任务（三步）</h3>
<ul>
<li>model→view的初始化绑定<br></li>
<li>view→model的绑定<br></li>
<li>model→view的绑定<br></li>
</ul>
<blockquote>
<p>看不太懂？不要着急，接下来先一步一步分析每一步都具体做了什么再回头看</p>
</blockquote>
<h3><a id="user-content-step1--modelview的初始化绑定" class="anchor" aria-hidden="true" href="#step1--modelview的初始化绑定"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Step1 : model→view的初始化绑定.</h3>
<p>很简单，就是让v-mode="text"和{{text}}绑定到的data中text的值。这里会有两个函数帮我们做事情，一个是<code>node2Fragment</code>函数，帮我们取到结点，
一个是<code>compile</code>函数，操作我们取到的node结点的值去等于对应的data值，这样就完成了model到view的第一次初始化绑定。</p>
<div class="highlight highlight-source-js"><pre>  <span class="pl-k">function</span> <span class="pl-en">node2Fragment</span>(<span class="pl-smi">node</span>,<span class="pl-smi">vm</span>){
      <span class="pl-c"><span class="pl-c">//</span>这里是dom劫持，vue会新建一个文档片段来替换dom中本来的结点</span>
      <span class="pl-k">var</span> flag<span class="pl-k">=</span><span class="pl-c1">document</span>.<span class="pl-c1">createDocumentFragment</span>();
      <span class="pl-c"><span class="pl-c">//</span>子节点</span>
      <span class="pl-k">var</span> child;
      <span class="pl-k">while</span>(child<span class="pl-k">=</span><span class="pl-smi">node</span>.<span class="pl-c1">firstChild</span>){
          <span class="pl-c"><span class="pl-c">//</span>开始编译每个结点</span>
          <span class="pl-en">compile</span>(child,vm);
          <span class="pl-c"><span class="pl-c">//</span>appendchild方法会自动删除node对象的child结点</span>
          <span class="pl-smi">flag</span>.<span class="pl-c1">appendChild</span>(child)
      }
      <span class="pl-k">return</span> flag;
  }</pre></div>
<div class="highlight highlight-source-js"><pre>  <span class="pl-k">function</span> <span class="pl-en">compile</span>(<span class="pl-smi">node</span>,<span class="pl-smi">vm</span>){
    <span class="pl-k">var</span> reg<span class="pl-k">=</span><span class="pl-sr"><span class="pl-pds">/</span><span class="pl-cce">\{\{</span>(<span class="pl-c1">.</span><span class="pl-k">*</span>)<span class="pl-cce">\}\}</span><span class="pl-pds">/</span></span>;
    <span class="pl-c"><span class="pl-c">//</span>节点类型为元素</span>
    <span class="pl-k">if</span>(<span class="pl-smi">node</span>.<span class="pl-c1">nodeType</span><span class="pl-k">===</span><span class="pl-c1">1</span>){
      <span class="pl-k">var</span> attr<span class="pl-k">=</span><span class="pl-smi">node</span>.<span class="pl-c1">attributes</span>;
      <span class="pl-k">for</span>(<span class="pl-k">var</span> i<span class="pl-k">=</span><span class="pl-c1">0</span>;i<span class="pl-k">&lt;</span><span class="pl-smi">attr</span>.<span class="pl-c1">length</span>;i<span class="pl-k">++</span>){
        <span class="pl-c"><span class="pl-c">//</span>匹配v-model这个属性名称</span>
        <span class="pl-k">if</span>(attr[i].<span class="pl-c1">nodeName</span><span class="pl-k">==</span><span class="pl-s"><span class="pl-pds">'</span>v-model<span class="pl-pds">'</span></span>){
          <span class="pl-k">var</span> name<span class="pl-k">=</span>attr[i].<span class="pl-c1">nodeValue</span>;
          <span class="pl-c"><span class="pl-c">//</span>将data的值赋给gainode</span>
          <span class="pl-smi">node</span>.<span class="pl-c1">value</span><span class="pl-k">=</span><span class="pl-smi">vm</span>.<span class="pl-c1">data</span>[name];
        }
      }
    };
    <span class="pl-c"><span class="pl-c">//</span>节点类型为text</span>
    <span class="pl-k">if</span>(<span class="pl-smi">node</span>.<span class="pl-c1">nodeType</span><span class="pl-k">===</span><span class="pl-c1">3</span>){
      <span class="pl-k">if</span>(<span class="pl-smi">reg</span>.<span class="pl-c1">test</span>(<span class="pl-smi">node</span>.<span class="pl-c1">nodeValue</span>)){
        <span class="pl-k">var</span> name<span class="pl-k">=</span><span class="pl-c1">RegExp</span>.<span class="pl-smi">$1</span>;
        name<span class="pl-k">=</span><span class="pl-smi">name</span>.<span class="pl-en">trim</span>();
        <span class="pl-c"><span class="pl-c">//</span>将data的值赋给该node</span>
        <span class="pl-smi">node</span>.<span class="pl-c1">nodeValue</span><span class="pl-k">=</span><span class="pl-smi">vm</span>.<span class="pl-c1">data</span>[name];
      }
    }
  }</pre></div>
<div class="highlight highlight-source-js"><pre>  <span class="pl-c"><span class="pl-c">//</span>Vue对象</span>
  <span class="pl-k">function</span> <span class="pl-en">Vue</span>(<span class="pl-smi">options</span>){
    <span class="pl-c1">this</span>.<span class="pl-c1">data</span><span class="pl-k">=</span><span class="pl-smi">options</span>.<span class="pl-c1">data</span>;
    <span class="pl-k">var</span> id<span class="pl-k">=</span><span class="pl-smi">options</span>.<span class="pl-smi">el</span>;
    <span class="pl-k">var</span> dom<span class="pl-k">=</span><span class="pl-en">node2Fragment</span>(<span class="pl-c1">document</span>.<span class="pl-c1">getElementById</span>(id),<span class="pl-c1">this</span>);
    <span class="pl-c"><span class="pl-c">//</span>编译完成后，将dom片段添加到el挂载的元素上(app)</span>
    <span class="pl-c1">document</span>.<span class="pl-c1">getElementById</span>(id).<span class="pl-c1">appendChild</span>(dom)
  }
  <span class="pl-c"><span class="pl-c">//</span>调用Vue</span>
  <span class="pl-k">var</span> vm<span class="pl-k">=</span><span class="pl-k">new</span> <span class="pl-en">Vue</span>({
      el<span class="pl-k">:</span><span class="pl-s"><span class="pl-pds">'</span>app<span class="pl-pds">'</span></span>,
      data<span class="pl-k">:</span>{
          text<span class="pl-k">:</span><span class="pl-s"><span class="pl-pds">'</span>hello world!<span class="pl-pds">'</span></span>
      }
  })</pre></div>
<p>最终达到的效果如下图：v-model绑定的input和{{text}}的值和data中的text保持一致<br>
<a target="_blank" href="https://github.com/coderzzp/vue-come-true/blob/master/vue-come-true-First/img/QQ%E6%88%AA%E5%9B%BE20170603152333.jpg"><img src="https://github.com/coderzzp/vue-come-true/raw/master/vue-come-true-First/img/QQ%E6%88%AA%E5%9B%BE20170603152333.jpg" alt="" style="max-width:100%;"></a></p>
<h3><a id="user-content-step2--viewmodel的绑定" class="anchor" aria-hidden="true" href="#step2--viewmodel的绑定"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Step2 : view→model的绑定.</h3>
<p>这一步的目标：当用户输入改变input的值(view层)时，反映到data中(model层)并改变对应的值<br>
方法：<br></p>
<ul>
<li>在complie编译的时候监听node，并改变data中的值为node.value;</li>
<li>通知data中的数据改变（这里会用到访问器属性，即<code>Object.defineProperty</code>）<br>
这里我们先完成第二个点，通知数据改变，在全局中新添加两个函数</li>
</ul>
<div class="highlight highlight-source-js"><pre>  <span class="pl-k">function</span> <span class="pl-en">defineReactive</span>(<span class="pl-smi">obj</span>,<span class="pl-smi">key</span>,<span class="pl-smi">val</span>){
    <span class="pl-c1">Object</span>.<span class="pl-en">defineProperty</span>(obj,key,{
      <span class="pl-en">get</span><span class="pl-k">:</span><span class="pl-k">function</span>(){
        <span class="pl-k">return</span> val
      },
      <span class="pl-en">set</span><span class="pl-k">:</span><span class="pl-k">function</span>(<span class="pl-smi">newVal</span>){
        <span class="pl-k">if</span>(newVal<span class="pl-k">===</span>val)<span class="pl-k">return</span> ;
        val<span class="pl-k">=</span>newVal;
        <span class="pl-c"><span class="pl-c">//</span>看到数据改变</span>
        <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-s"><span class="pl-pds">"</span>设置新的属性为<span class="pl-pds">"</span></span><span class="pl-k">+</span>val)
      }
    })
  }
  <span class="pl-k">function</span> <span class="pl-en">observe</span>(<span class="pl-smi">obj</span>,<span class="pl-smi">vm</span>){
    <span class="pl-c1">Object</span>.<span class="pl-c1">keys</span>(obj).<span class="pl-c1">forEach</span>(<span class="pl-k">function</span>(<span class="pl-smi">key</span>){
      <span class="pl-en">defineReactive</span>(vm,key,obj[key])
    })
  }</pre></div>
<div class="highlight highlight-source-js"><pre>  <span class="pl-c"><span class="pl-c">//</span>Vue对象</span>
  <span class="pl-k">function</span> <span class="pl-en">Vue</span>(<span class="pl-smi">options</span>){
    <span class="pl-c1">this</span>.<span class="pl-c1">data</span><span class="pl-k">=</span><span class="pl-smi">options</span>.<span class="pl-c1">data</span>;
    <span class="pl-k">var</span> id<span class="pl-k">=</span><span class="pl-smi">options</span>.<span class="pl-smi">el</span>;
    <span class="pl-k">var</span> data<span class="pl-k">=</span><span class="pl-c1">this</span>.<span class="pl-c1">data</span>;
    <span class="pl-c"><span class="pl-c">//</span>将data的属性全部通过访问器属性赋给vm对象，使读写vm实例的属性转成读写了vm.data的属性值，达到鱼目混珠的效果</span>
    <span class="pl-en">observe</span>(data,<span class="pl-c1">this</span>);
    <span class="pl-k">var</span> dom<span class="pl-k">=</span><span class="pl-en">node2Fragment</span>(<span class="pl-c1">document</span>.<span class="pl-c1">getElementById</span>(id),<span class="pl-c1">this</span>);
    <span class="pl-c"><span class="pl-c">//</span>编译完成后，将dom片段添加到el挂载的元素上(app)</span>
    <span class="pl-c1">document</span>.<span class="pl-c1">getElementById</span>(id).<span class="pl-c1">appendChild</span>(dom)
  }</pre></div>
<p>监听node(修改complie函数)</p>
<div class="highlight highlight-source-js"><pre>  <span class="pl-k">function</span> <span class="pl-en">compile</span>(<span class="pl-smi">node</span>,<span class="pl-smi">vm</span>){
    <span class="pl-k">var</span> reg<span class="pl-k">=</span><span class="pl-sr"><span class="pl-pds">/</span><span class="pl-cce">\{\{</span>(<span class="pl-c1">.</span><span class="pl-k">*</span>)<span class="pl-cce">\}\}</span><span class="pl-pds">/</span></span>;
    <span class="pl-c"><span class="pl-c">//</span>节点类型为元素</span>
    <span class="pl-k">if</span>(<span class="pl-smi">node</span>.<span class="pl-c1">nodeType</span><span class="pl-k">===</span><span class="pl-c1">1</span>){
      <span class="pl-k">var</span> attr<span class="pl-k">=</span><span class="pl-smi">node</span>.<span class="pl-c1">attributes</span>;
      <span class="pl-k">for</span>(<span class="pl-k">var</span> i<span class="pl-k">=</span><span class="pl-c1">0</span>;i<span class="pl-k">&lt;</span><span class="pl-smi">attr</span>.<span class="pl-c1">length</span>;i<span class="pl-k">++</span>){
        <span class="pl-c"><span class="pl-c">//</span>匹配v-model这个属性名称</span>
        <span class="pl-k">if</span>(attr[i].<span class="pl-c1">nodeName</span><span class="pl-k">==</span><span class="pl-s"><span class="pl-pds">'</span>v-model<span class="pl-pds">'</span></span>){
          <span class="pl-k">var</span> name<span class="pl-k">=</span>attr[i].<span class="pl-c1">nodeValue</span>;
          <span class="pl-smi">node</span>.<span class="pl-c1">addEventListener</span>(<span class="pl-s"><span class="pl-pds">'</span>input<span class="pl-pds">'</span></span>,<span class="pl-k">function</span>(<span class="pl-smi">e</span>){
            <span class="pl-c"><span class="pl-c">//</span>给对应的data属性赋值，并触发该属性的set函数</span>
            vm[name]<span class="pl-k">=</span><span class="pl-smi">e</span>.<span class="pl-c1">target</span>.<span class="pl-c1">value</span>;
          });
          <span class="pl-c"><span class="pl-c">//</span>将data值赋给该node,注意这里本来是vm.data[name]</span>
          <span class="pl-smi">node</span>.<span class="pl-c1">value</span><span class="pl-k">=</span>vm[name]
        }
      }
    };
    <span class="pl-c"><span class="pl-c">//</span>节点类型为text</span>
    <span class="pl-k">if</span>(<span class="pl-smi">node</span>.<span class="pl-c1">nodeType</span><span class="pl-k">===</span><span class="pl-c1">3</span>){
      <span class="pl-k">if</span>(<span class="pl-smi">reg</span>.<span class="pl-c1">test</span>(<span class="pl-smi">node</span>.<span class="pl-c1">nodeValue</span>)){
        <span class="pl-k">var</span> name<span class="pl-k">=</span><span class="pl-c1">RegExp</span>.<span class="pl-smi">$1</span>;
        name<span class="pl-k">=</span><span class="pl-smi">name</span>.<span class="pl-en">trim</span>();
        <span class="pl-c"><span class="pl-c">//</span>将data的值赋给该node,注意这里本来是vm.data[name]</span>
        <span class="pl-smi">node</span>.<span class="pl-c1">nodeValue</span><span class="pl-k">=</span>vm[name];
      }
    }
  }</pre></div>
<p>那么step2完成了，当用户在input中输入值，data属性值也会发生改变，这样一来就完成了model→view的一个实现过程<br>
<a target="_blank" href="https://github.com/coderzzp/vue-come-true/blob/master/vue-come-true-First/img/QQ%E6%88%AA%E5%9B%BE20170603171244.jpg"><img src="https://github.com/coderzzp/vue-come-true/raw/master/vue-come-true-First/img/QQ%E6%88%AA%E5%9B%BE20170603171244.jpg" alt="" style="max-width:100%;"></a><br></p>
<h3><a id="user-content-step3--modelview的绑定" class="anchor" aria-hidden="true" href="#step3--modelview的绑定"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Step3 : model→view的绑定</h3>
<p>诶不是之前已经绑定过一次model→view，怎么还要绑定？<br>
第一次绑定是初始化绑定，我们现在要完成的是，当用户改变data值，再回过头去改变view层，这里刚好可以用到一个设计模式：
观察者模式-让多个观察者同时监听某一个主题对象，这个主题对象的状态发生改变时就会通知所有观察者对象。<br>
<a target="_blank" href="https://github.com/coderzzp/vue-come-true/blob/master/vue-come-true-First/img/925891-20161120160541513-1856723431.png"><img src="https://github.com/coderzzp/vue-come-true/raw/master/vue-come-true-First/img/925891-20161120160541513-1856723431.png" alt="" style="max-width:100%;"></a><br>
放到这里就是：每个data属性值在<code>defineReactive</code>函数监听处理的时候，添加一个主题对象，当data属性发生改变,通过set函数去通知所有的观察者们，
那么如何添加观察者们呢，就是在<code>complie</code>函数编译node时，通过初始化value值，触发set函数，在set函数中为主题对象添加
观察者。有点难理解？直接看代码就明白了。</p>
<div class="highlight highlight-source-js"><pre>  <span class="pl-k">function</span> <span class="pl-en">compile</span>(<span class="pl-smi">node</span>,<span class="pl-smi">vm</span>){
    <span class="pl-k">var</span> reg<span class="pl-k">=</span><span class="pl-sr"><span class="pl-pds">/</span><span class="pl-cce">\{\{</span>(<span class="pl-c1">.</span><span class="pl-k">*</span>)<span class="pl-cce">\}\}</span><span class="pl-pds">/</span></span>;
    <span class="pl-c"><span class="pl-c">//</span>节点类型为元素(这块在这里并没有修改)</span>
    <span class="pl-c"><span class="pl-c">//</span>节点类型为text</span>
    <span class="pl-k">if</span>(<span class="pl-smi">node</span>.<span class="pl-c1">nodeType</span><span class="pl-k">===</span><span class="pl-c1">3</span>){
      <span class="pl-k">if</span>(<span class="pl-smi">reg</span>.<span class="pl-c1">test</span>(<span class="pl-smi">node</span>.<span class="pl-c1">nodeValue</span>)){
        <span class="pl-k">var</span> name<span class="pl-k">=</span><span class="pl-c1">RegExp</span>.<span class="pl-smi">$1</span>;
        name<span class="pl-k">=</span><span class="pl-smi">name</span>.<span class="pl-en">trim</span>();
        <span class="pl-c"><span class="pl-c">//</span>初始化数据，并给对应的data属性值添加观察者</span>
        <span class="pl-k">new</span> <span class="pl-en">Watcher</span>(vm,node,name); 
      }
    }
  }</pre></div>
<p>我们注意到新建了一个Watcher对象，这个对象的作用就是初始化数据(step1做的工作)，以及触发get函数,添加这个node到观察者<br></p>
<div class="highlight highlight-source-js"><pre>  <span class="pl-k">function</span> <span class="pl-en">Watcher</span>(<span class="pl-smi">vm</span>,<span class="pl-smi">node</span>,<span class="pl-smi">name</span>){
    <span class="pl-c"><span class="pl-c">//</span>Dep.target是一个Dep的静态属性,表示当前观察者。</span>
    <span class="pl-smi">Dep</span>.<span class="pl-c1">target</span><span class="pl-k">=</span><span class="pl-c1">this</span>;
    <span class="pl-c1">this</span>.<span class="pl-c1">name</span><span class="pl-k">=</span>name;
    <span class="pl-c1">this</span>.<span class="pl-smi">node</span><span class="pl-k">=</span>node;
    <span class="pl-c1">this</span>.<span class="pl-smi">vm</span><span class="pl-k">=</span>vm;
    <span class="pl-c"><span class="pl-c">//</span>订阅者执行一次更新视图</span>
    <span class="pl-c1">this</span>.<span class="pl-en">update</span>();
    <span class="pl-smi">Dep</span>.<span class="pl-c1">target</span><span class="pl-k">=</span><span class="pl-c1">null</span>;
  }
  <span class="pl-smi">Watcher</span>.<span class="pl-c1">prototype</span><span class="pl-k">=</span>{
    <span class="pl-en">update</span><span class="pl-k">:</span><span class="pl-k">function</span>(){
      <span class="pl-c"><span class="pl-c">//</span>触发对应data属性值的get函数</span>
      <span class="pl-c1">this</span>.<span class="pl-c1">get</span>();
      <span class="pl-c1">this</span>.<span class="pl-smi">node</span>.<span class="pl-c1">nodeValue</span><span class="pl-k">=</span><span class="pl-c1">this</span>.<span class="pl-c1">value</span>;
    },
    <span class="pl-en">get</span><span class="pl-k">:</span><span class="pl-k">function</span>(){
      <span class="pl-c1">this</span>.<span class="pl-c1">value</span><span class="pl-k">=</span><span class="pl-c1">this</span>.<span class="pl-smi">vm</span>[<span class="pl-c1">this</span>.<span class="pl-c1">name</span>]
    }
  }</pre></div>
<p>观察者设置好了，现在设置主题，在<code>defineReactive</code>函数里</p>
<div class="highlight highlight-source-js"><pre>  <span class="pl-k">function</span> <span class="pl-en">defineReactive</span>(<span class="pl-smi">obj</span>,<span class="pl-smi">key</span>,<span class="pl-smi">val</span>){
    <span class="pl-c"><span class="pl-c">//</span>定义一个主题</span>
    <span class="pl-k">var</span> dep<span class="pl-k">=</span><span class="pl-k">new</span> <span class="pl-en">Dep</span>();
    <span class="pl-c1">Object</span>.<span class="pl-en">defineProperty</span>(obj,key,{
      <span class="pl-en">get</span><span class="pl-k">:</span><span class="pl-k">function</span>(){
        <span class="pl-c"><span class="pl-c">//</span>添加订阅者watcher到主题对象Dep</span>
        <span class="pl-k">if</span>(<span class="pl-smi">Dep</span>.<span class="pl-c1">target</span>)<span class="pl-smi">dep</span>.<span class="pl-en">addSub</span>(<span class="pl-smi">Dep</span>.<span class="pl-c1">target</span>)
        <span class="pl-k">return</span> val
      },
      <span class="pl-en">set</span><span class="pl-k">:</span><span class="pl-k">function</span>(<span class="pl-smi">newVal</span>){
        <span class="pl-k">if</span>(newVal<span class="pl-k">===</span>val)<span class="pl-k">return</span> ;
        val<span class="pl-k">=</span>newVal;
        <span class="pl-c"><span class="pl-c">//</span>作为发布者发出通知（更新所有订阅了这个属性的view）</span>
        <span class="pl-smi">dep</span>.<span class="pl-en">notify</span>();
      }
    })
  }</pre></div>
<p>主题的结构：</p>
<div class="highlight highlight-source-js"><pre>  <span class="pl-k">function</span> <span class="pl-en">Dep</span>(){
    <span class="pl-c"><span class="pl-c">//</span>主题的订阅者们</span>
    <span class="pl-c1">this</span>.<span class="pl-smi">subs</span><span class="pl-k">=</span>[];
  }
  <span class="pl-smi">Dep</span>.<span class="pl-c1">prototype</span><span class="pl-k">=</span>{
    <span class="pl-c"><span class="pl-c">//</span>添加订阅者的方法</span>
    <span class="pl-en">addSub</span><span class="pl-k">:</span><span class="pl-k">function</span>(<span class="pl-smi">sub</span>){
      <span class="pl-c1">this</span>.<span class="pl-smi">subs</span>.<span class="pl-c1">push</span>(sub);
    },
    <span class="pl-c"><span class="pl-c">//</span>发布信息的方法（让订阅者们全部更新view）</span>
    <span class="pl-en">notify</span><span class="pl-k">:</span><span class="pl-k">function</span>(){
      <span class="pl-c1">this</span>.<span class="pl-smi">subs</span>.<span class="pl-c1">forEach</span>(<span class="pl-k">function</span>(<span class="pl-smi">sub</span>){
        <span class="pl-smi">sub</span>.<span class="pl-en">update</span>();
      })
    }
  }</pre></div>
<p>如此一来，一个简单的MVVM就实现了，思维导图如下：<br>
<a target="_blank" href="https://github.com/coderzzp/vue-come-true/blob/master/vue-come-true-First/img/132184689-57b310ea1804f_articlex.png"><img src="https://github.com/coderzzp/vue-come-true/raw/master/vue-come-true-First/img/132184689-57b310ea1804f_articlex.png" alt="" style="max-width:100%;"></a><br>
不过这只是Vue的冰山一角，只是实现了一个v-model，陆陆续续会更新其他的操作和一些细节，敬请期待，如果你
看完了并且有所收获不妨点个star(滑稽脸)</p>
</article>
  </div>
  </body>
</html>

